#!/bin/bash
# merge-main.sh
# Merge testing -> main (Produktionsfreigabe) mit Sicherheits-Checks

set -e

# 1. Aktuelle Branches holen
git fetch origin --prune

# 2. Prüfen, ob wir auf testing sind
if [[ $(git branch --show-current) != "testing" ]]; then
  echo "❗ Du musst auf 'testing' sein! Nutze: git checkout testing"
  exit 1
fi

# 3. Prüfen, ob ungespeicherte Änderungen da sind
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "❗ Es gibt uncommitted Changes – bitte committen oder stashen."
  exit 1
fi

# 4. Sicher pushen
pushrepo   # Sicherheits-Checks vor dem Merge

# 5. Branch wechseln & mergen
git checkout main
git merge testing --no-ff -m "🔀 Merge testing → main (Produktionsfreigabe)"

# 6. preview.yml nur in main entfernen
if [ -f .github/workflows/preview.yml ]; then
  git rm .github/workflows/preview.yml
  git commit -m "🧹 Entferne preview.yml im main-Branch"
fi

# 7. Push & zurück zu testing
git push origin main
git checkout testing

echo "✅ Merge testing → main abgeschlossen und 'preview.yml' entfernt."
