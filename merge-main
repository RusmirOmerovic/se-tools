#!/bin/bash
# merge-main.sh
# Merge testing -> main (Produktionsfreigabe) mit Sicherheits-Checks

set -e

# 1. Aktuelle Branches holen
git fetch origin --prune

# 2. PrÃ¼fen, ob wir auf testing sind
if [[ $(git branch --show-current) != "testing" ]]; then
  echo "â— Du musst auf 'testing' sein! Nutze: git checkout testing"
  exit 1
fi

# 3. PrÃ¼fen, ob ungespeicherte Ã„nderungen da sind
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "â— Es gibt uncommitted Changes â€“ bitte committen oder stashen."
  exit 1
fi

# 4. Sicher pushen
pushrepo   # Sicherheits-Checks vor dem Merge

# 5. Branch wechseln & mergen
git checkout main
git merge testing --no-ff -m "ğŸ”€ Merge testing â†’ main (Produktionsfreigabe)"

# 6. preview.yml nur in main entfernen
if [ -f .github/workflows/preview.yml ]; then
  git rm .github/workflows/preview.yml
  git commit -m "ğŸ§¹ Entferne preview.yml im main-Branch"
fi

# 7. Push & zurÃ¼ck zu testing
git push origin main
git checkout testing

echo "âœ… Merge testing â†’ main abgeschlossen und 'preview.yml' entfernt."
