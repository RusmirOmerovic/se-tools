#!/usr/bin/env bash
# projectnew – Neues Projekt + GitHub Repo + Supabase-Eintrag
# Plattform: macOS (Keychain) – liest SUPABASE_URL & SUPABASE_SERVICE_ROLE aus dem Schlüsselbund
# GitHub-Token: aus Keychain (se-tools-gh-token) ODER gh auth ODER Fallback Prompt

set -euo pipefail

# ===== Farben =====
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# ===== Konfig =====
TEMPLATE_REPO="https://github.com/RusmirOmerovic/html-template-se.git"
USERNAME="RusmirOmerovic"
GITHUB_API="https://api.github.com"

# ===== Helfer =====
die() { echo -e "${RED}❌ $*${NC}" >&2; exit 1; }
need() { command -v "$1" >/dev/null 2>&1 || die "Benötigtes Tool fehlt: $1"; }

need git
need curl
need jq

# --- GitHub Token besorgen (Keychain -> gh auth -> Prompt) ---
get_github_token() {
  local t
  t="$(security find-generic-password -a "$USER" -s "se-tools-gh-token" -w 2>/dev/null || true)"
  if [[ -z "${t}" ]]; then
    if command -v gh >/dev/null 2>&1 && gh auth status >/dev/null 2>&1; then
      t="$(gh auth token 2>/dev/null || true)"
    fi
  fi
  if [[ -z "${t}" ]]; then
    read -s -p "🔑 GitHub Token (repo+workflow): " t; echo
    # Optional: gleich sicher ablegen
    security add-generic-password -a "$USER" -s "se-tools-gh-token" -w "$t" -U >/dev/null 2>&1 || true
  fi
  [[ -n "${t}" ]] || die "Kein GitHub-Token verfügbar."
  echo -n "${t}"
}

# --- Supabase Secrets aus Keychain laden (macOS) ---
get_supabase_secret() {
  local name="$1"
  security find-generic-password -a "$USER" -s "$name" -w 2>/dev/null | tr -d '\r\n' || true
}

SUPABASE_URL="$(get_supabase_secret "SUPABASE_URL")"
SUPABASE_SERVICE_ROLE="$(get_supabase_secret "SUPABASE_SERVICE_ROLE")"
[[ -n "${SUPABASE_URL}" && -n "${SUPABASE_SERVICE_ROLE}" ]] \
  || die "Supabase Keys nicht im Keychain gefunden. Bitte zuerst 'setup-supabase-secrets' ausführen."

# ===== DEBUG (keine Geheimnisse ausgeben) =====
echo -e "${CYAN}DEBUG${NC} Supabase URL: ${SUPABASE_URL}"
echo -e "${CYAN}DEBUG${NC} Service-Role Länge: ${#SUPABASE_SERVICE_ROLE}"

# ===== Projektnamen =====
PROJECT_NAME="${1:-}"
if [[ -z "${PROJECT_NAME}" ]]; then
  read -r -p "📦 Projektname: " PROJECT_NAME
fi
[[ -n "${PROJECT_NAME}" ]] || die "Projektnamen angeben!"

ZIELORDNER="${PWD}/${PROJECT_NAME}"
[[ -d "${ZIELORDNER}" ]] && die "Ordner '${ZIELORDNER}' existiert bereits."

# ===== Nutzer-E-Mail (Supabase Zuordnung) =====
read -r -p "📧 Deine E-Mail-Adresse: " SUPABASE_USER_MAIL
[[ -n "${SUPABASE_USER_MAIL}" ]] || die "E-Mail darf nicht leer sein."

# ===== Team / Fällig / Status =====
read -r -p "👥 Teammitglieder (frei text): " TEAM_NAMES

# Default: in 14 Tagen
DEFAULT_DUE="$(date -v+14d +%F 2>/dev/null || date -d '+14 days' +%F)"
read -r -p "📅 Fälligkeitsdatum [YYYY-MM-DD] (Default ${DEFAULT_DUE}): " DUE_DATE
DUE_DATE="${DUE_DATE:-$DEFAULT_DUE}"

# simple ISO-Check
if ! [[ "${DUE_DATE}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
  die "Fälligkeitsdatum muss im Format YYYY-MM-DD sein."
fi

echo -e "📌 Status wählen: [angemeldet|geplant|laufend|abgeschlossen]"
read -r -p "Status (Default: geplant): " MILESTONE_STATUS
MILESTONE_STATUS="${MILESTONE_STATUS:-geplant}"

# ===== GitHub Repo anlegen + lokalen Template-Clone vorbereiten =====
echo -e "${CYAN}→ GitHub Repo & lokales Projekt anlegen …${NC}"
GITHUB_TOKEN="$(get_github_token)"

git clone "${TEMPLATE_REPO}" "${ZIELORDNER}"
cd "${ZIELORDNER}"
rm -rf .git && git init

# .gitignore sicherstellen
printf ".env\n.DS_Store\nnode_modules\n" > .gitignore

git add . && git commit -m "🆕 Neues Projekt: ${PROJECT_NAME}"

# Remote Repo via API
RESP_CODE="$(curl -s -o /dev/null -w "%{http_code}" \
  -H "Authorization: token ${GITHUB_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{\"name\":\"${PROJECT_NAME}\", \"private\":false}" \
  "${GITHUB_API}/user/repos")"

if [[ "${RESP_CODE}" != "201" ]]; then
  die "Fehler bei GitHub Repo-Erstellung (HTTP ${RESP_CODE})."
fi

git remote add origin "https://github.com/${USERNAME}/${PROJECT_NAME}.git"
git branch -M main
git push -u origin main

REPO_URL="https://github.com/${USERNAME}/${PROJECT_NAME}"

# ===== Supabase: UserID holen, Projekt + Milestone anlegen =====
echo -e "${CYAN}→ Supabase Einträge erstellen …${NC}"

USER_ID="$(curl -s \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  "${SUPABASE_URL}/rest/v1/user_profiles?email=eq.${SUPABASE_USER_MAIL}&select=id&limit=1" \
  | jq -r '.[0].id')"

[[ "${USER_ID}" != "null" && -n "${USER_ID}" ]] || die "Kein user_profiles-Eintrag für ${SUPABASE_USER_MAIL} gefunden. Bitte zuerst im Frontend registrieren."

STARTDATUM="$(date +%F)"
PROJECT_JSON="$(jq -n --arg name "${PROJECT_NAME}" --arg startdatum "${STARTDATUM}" --arg user_id "${USER_ID}" --arg status "angemeldet" \
  '{name:$name,status:$status,startdatum:$startdatum,owner_id:$user_id}')"

PROJECT_RESPONSE="$(curl -s \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json" -H "Prefer: return=representation" \
  -d "${PROJECT_JSON}" \
  "${SUPABASE_URL}/rest/v1/projects")"

PROJECT_ID="$(echo "${PROJECT_RESPONSE}" | jq -r '.[0].id')"
[[ "${PROJECT_ID}" != "null" && -n "${PROJECT_ID}" ]] || die "Projekt konnte in Supabase nicht angelegt werden: ${PROJECT_RESPONSE}"

MILESTONE_JSON="$(jq -n \
  --arg project_id "${PROJECT_ID}" \
  --arg title "Team: ${TEAM_NAMES}" \
  --arg description "${REPO_URL}" \
  --arg due_date "${DUE_DATE}" \
  --arg status "${MILESTONE_STATUS}" \
  '{project_id:$project_id,title:$title,description:$description,due_date:$due_date,status:$status}')"

MS_RESP="$(curl -s \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json" \
  -d "${MILESTONE_JSON}" \
  "${SUPABASE_URL}/rest/v1/milestones")"

# Optional: minimaler Check
MS_ERR="$(echo "${MS_RESP}" | jq -r 'if type=="object" and has("message") then .message else empty end' 2>/dev/null || true)"
[[ -z "${MS_ERR}" ]] || die "Milestone-Insert fehlgeschlagen: ${MS_ERR}"

echo -e "${GREEN}✅ Projekt '${PROJECT_NAME}' erstellt & auf GitHub gepusht.${NC}"
echo -e "${GREEN}✅ Supabase: project=${PROJECT_ID}, milestone OK.${NC}"
echo -e "🔗 ${REPO_URL}"
