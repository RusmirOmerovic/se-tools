#!/usr/bin/env bash
# projectnew.sh ‚Äì Neues Projekt (lokal + GitHub) + Supabase-Eintrag
# Voraussetzung: macOS Keychain (security), git, curl, jq
set -euo pipefail

GREEN='\033[0;32m'; CYAN='\033[0;36m'; RED='\033[0;31m'; NC='\033[0m'

TEMPLATE_REPO="https://github.com/RusmirOmerovic/html-template-se.git"
USERNAME="RusmirOmerovic"
GITHUB_API="https://api.github.com"
KEYCHAIN_GH="se-tools-gh-token"
SVC_URL="SUPABASE_URL"
SVC_ROLE="SUPABASE_SERVICE_ROLE"

need(){ command -v "$1" >/dev/null 2>&1 || { echo -e "${RED}‚ùå fehlt: $1${NC}"; exit 1; }; }
need git; need curl; need jq; need security

get_github_token() {
  local t=""
  if security find-generic-password -s "$KEYCHAIN_GH" >/dev/null 2>&1; then
    t="$(security find-generic-password -s "$KEYCHAIN_GH" -w | tr -d '\r\n')"
  fi
  if [[ -z "$t" ]]; then
    read -s -p "üîë GitHub-Token (repo+workflow): " t; echo
    security add-generic-password -a "$USER" -s "$KEYCHAIN_GH" -w "$t" -U >/dev/null 2>&1 || true
    echo -e "${CYAN}üíæ Token im macOS Keychain gespeichert.${NC}"
  fi
  echo -n "$t"
}

get_secret(){ security find-generic-password -a "$USER" -s "$1" -w 2>/dev/null | tr -d '\r\n' || true; }

SUPABASE_URL="$(get_secret "$SVC_URL")"; SUPABASE_URL="${SUPABASE_URL%/}"
SUPABASE_SERVICE_ROLE="$(get_secret "$SVC_ROLE")"
[[ -n "$SUPABASE_URL" && -n "$SUPABASE_SERVICE_ROLE" ]] || { echo -e "${RED}‚ùå Supabase-Keys fehlen. Erst 'setup-supabase-secrets' ausf√ºhren.${NC}"; exit 1; }

echo -e "${CYAN}DEBUG${NC} Supabase URL: $SUPABASE_URL"
printf "${CYAN}DEBUG${NC} Service-Role L√§nge: %s\n" "${#SUPABASE_SERVICE_ROLE}"

if [ $# -lt 1 ]; then echo -e "${RED}‚ùå Projektnamen angeben!${NC}"; exit 1; fi
PROJECT_NAME="$1"
ZIELORDNER="$PWD/$PROJECT_NAME"
[ -d "$ZIELORDNER" ] && { echo -e "${RED}‚ùå Ordner '$ZIELORDNER' existiert bereits.${NC}"; exit 1; }

read -r -p "üìß Deine E-Mail-Adresse: " SUPABASE_USER_MAIL
[ -n "$SUPABASE_USER_MAIL" ] || { echo -e "${RED}‚ùå E-Mail darf nicht leer sein.${NC}"; exit 1; }
read -r -p "üë• Teammitglieder (frei Text): " TEAM_NAMES

DEFAULT_DUE="$(date -v+14d +%F 2>/dev/null || date -d '+14 days' +%F)"
read -r -p "üìÖ F√§lligkeitsdatum [YYYY-MM-DD] (Default ${DEFAULT_DUE}): " DUE_DATE
DUE_DATE="${DUE_DATE:-$DEFAULT_DUE}"
[[ "$DUE_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]] || { echo -e "${RED}‚ùå Datum muss YYYY-MM-DD sein.${NC}"; exit 1; }

echo -e "üìå Status w√§hlen: [angemeldet|geplant|laufend|abgeschlossen]"
read -r -p "Status (Default: geplant): " MILESTONE_STATUS
MILESTONE_STATUS="${MILESTONE_STATUS:-geplant}"

echo -e "${CYAN}‚Üí GitHub Repo anlegen & pushen ‚Ä¶${NC}"
GITHUB_TOKEN="$(get_github_token)"

EXIST_HTTP="$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GITHUB_TOKEN" \
  "$GITHUB_API/repos/$USERNAME/$PROJECT_NAME")"
if [ "$EXIST_HTTP" = "200" ]; then
  echo -e "${RED}‚ùå Repo '$USERNAME/$PROJECT_NAME' existiert bereits.${NC}"
  exit 1
fi

git clone "$TEMPLATE_REPO" "$ZIELORDNER"
cd "$ZIELORDNER"
rm -rf .git && git init
git config user.name  >/dev/null 2>&1 || git config user.name  "$USERNAME"
git config user.email >/dev/null 2>&1 || git config user.email "$SUPABASE_USER_MAIL"
echo -e ".env\n.DS_Store\nnode_modules" > .gitignore
git add . && git commit -m "üÜï Neues Projekt: $PROJECT_NAME"

RESP_CODE="$(curl -s -o /dev/null -w "%{http_code}" \
  -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  -H "Content-Type: application/json" \
  -d "{\"name\":\"$PROJECT_NAME\",\"private\":false}" \
  "$GITHUB_API/user/repos")"
if [ "$RESP_CODE" != "201" ]; then
  echo -e "${RED}‚ùå GitHub Repo-Erstellung fehlgeschlagen (HTTP $RESP_CODE).${NC}"; exit 1
fi

git remote add origin "https://github.com/$USERNAME/$PROJECT_NAME.git"
git branch -M main
git push -u origin main
REPO_URL="https://github.com/$USERNAME/$PROJECT_NAME"

# Auth-Ping
AUTH_HTTP="$(curl -s -o /dev/null -w "%{http_code}" \
  -H "apikey: $SUPABASE_SERVICE_ROLE" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
  "$SUPABASE_URL/rest/v1/user_profiles?select=id&limit=1")"
if [ "$AUTH_HTTP" != "200" ]; then
  echo -e "${RED}‚ùå Supabase Auth-Check fehlgeschlagen (HTTP $AUTH_HTTP). Pr√ºfe URL & Service-Role-Key.${NC}"
  exit 1
fi

# User-ID
echo -e "${CYAN}‚Üí Supabase: User & Projekt anlegen ‚Ä¶${NC}"
EMAIL_ENC="$(printf '%s' "$SUPABASE_USER_MAIL" | jq -sRr @uri)"
USER_Q="${SUPABASE_URL}/rest/v1/user_profiles?email=eq.${EMAIL_ENC}&select=id&limit=1"
USER_BODY="$(mktemp)"
USER_HTTP="$(curl -s -o "$USER_BODY" -w "%{http_code}" \
  -H "apikey: $SUPABASE_SERVICE_ROLE" \
  -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
  "$USER_Q")"
if [ "$USER_HTTP" != "200" ]; then
  echo -e "${RED}‚ùå user_profiles Query fehlgeschlagen (HTTP $USER_HTTP):${NC} $(cat "$USER_BODY")"; rm -f "$USER_BODY"; exit 1
fi
USER_ID="$(jq -r '.[0].id // empty' < "$USER_BODY")"; rm -f "$USER_BODY"
[ -n "$USER_ID" ] || { echo -e "${RED}‚ùå Kein user_profiles Eintrag f√ºr '$SUPABASE_USER_MAIL'. Bitte zuerst im Frontend registrieren.${NC}"; exit 1; }

# user_roles Upsert
read -r -p "üë§ Rolle f√ºr den Projekt-Owner [student|tutor|owner] (Default: student): " OWNER_ROLE
OWNER_ROLE="${OWNER_ROLE:-student}"
ROLE_JSON="$(jq -n --arg role "$OWNER_ROLE" --arg user_id "$USER_ID" '{role:$role,user_id:$user_id}')"
ROLE_BODY="$(mktemp)"
ROLE_HTTP="$(curl -s -o "$ROLE_BODY" -w "%{http_code}" \
  -H "apikey: $SUPABASE_SERVICE_ROLE" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
  -H "Content-Type: application/json" -H "Prefer: resolution=merge-duplicates,return=representation" \
  -d "$ROLE_JSON" "${SUPABASE_URL}/rest/v1/user_roles?on_conflict=user_id")"
if [[ ! "$ROLE_HTTP" =~ ^20[01]$ ]]; then
  echo -e "${RED}‚ùå Upsert user_roles fehlgeschlagen (HTTP $ROLE_HTTP):${NC} $(cat "$ROLE_BODY")"; rm -f "$ROLE_BODY"; exit 1
fi
ROLE_ROW_USER_ID="$(jq -r '.[0].user_id // empty' < "$ROLE_BODY")"; rm -f "$ROLE_BODY"
[[ "$ROLE_ROW_USER_ID" == "$USER_ID" ]] || { echo -e "${RED}‚ùå user_roles.user_id ‚â† user_profiles.id.${NC}"; exit 1; }

# projects Insert
STARTDATUM="$(date +%F)"
PROJECT_JSON="$(jq -n --arg name "$PROJECT_NAME" --arg status "angemeldet" --arg startdatum "$STARTDATUM" --arg owner_id "$USER_ID" \
  '{name:$name,status:$status,startdatum:$startdatum,owner_id:$owner_id}')"
PRJ_BODY="$(mktemp)"
PRJ_HTTP="$(curl -s -o "$PRJ_BODY" -w "%{http_code}" \
  -H "apikey: $SUPABASE_SERVICE_ROLE" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
  -H "Content-Type: application/json" -H "Prefer: return=representation" \
  -d "$PROJECT_JSON" "${SUPABASE_URL}/rest/v1/projects")"
if [[ ! "$PRJ_HTTP" =~ ^20[01]$ ]]; then
  echo -e "${RED}‚ùå Projekt-Insert fehlgeschlagen (HTTP $PRJ_HTTP):${NC} $(cat "$PRJ_BODY")"; rm -f "$PRJ_BODY"; exit 1
fi
PROJECT_ID="$(jq -r '.[0].id // empty' < "$PRJ_BODY")"; rm -f "$PRJ_BODY"
[ -n "$PROJECT_ID" ] || { echo -e "${RED}‚ùå Supabase hat keine Projekt-ID zur√ºckgegeben.${NC}"; exit 1; }

# milestones Insert
MILESTONE_JSON="$(jq -n --arg project_id "$PROJECT_ID" --arg title "Team: $TEAM_NAMES" --arg description "$REPO_URL" \
  --arg due_date "$DUE_DATE" --arg status "$MILESTONE_STATUS" \
  '{project_id:$project_id,title:$title,description:$description,due_date:$due_date,status:$status}')"
MS_BODY="$(mktemp)"
MS_HTTP="$(curl -s -o "$MS_BODY" -w "%{http_code}" \
  -H "apikey: $SUPABASE_SERVICE_ROLE" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
  -H "Content-Type: application/json" -H "Prefer: return=representation" \
  -d "$MILESTONE_JSON" "${SUPABASE_URL}/rest/v1/milestones")"
if [[ ! "$MS_HTTP" =~ ^20[01]$ ]]; then
  echo -e "${RED}‚ùå Milestone-Insert fehlgeschlagen (HTTP $MS_HTTP):${NC} $(cat "$MS_BODY")"; rm -f "$MS_BODY"; exit 1
fi
MS_ID="$(jq -r '.[0].id // empty' < "$MS_BODY")"; rm -f "$MS_BODY"
[ -n "$MS_ID" ] || { echo -e "${RED}‚ùå Supabase hat keine Milestone-ID zur√ºckgegeben.${NC}"; exit 1; }

echo -e "${GREEN}‚úÖ Projekt '$PROJECT_NAME' erstellt & auf GitHub gepusht.${NC}"
echo -e "${GREEN}‚úÖ Supabase: project=${PROJECT_ID}, milestone=${MS_ID}.${NC}"
echo -e "üîó $REPO_URL"
