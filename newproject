#!/bin/bash
# newproject.sh ‚Äì Neues Projekt aus Template erstellen + GitHub-Repo anlegen

set -e
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

TEMPLATE_REPO="https://github.com/RusmirOmerovic/html-template-se.git"
USERNAME="RusmirOmerovic"
GITHUB_API="https://api.github.com"
CONFIG_DIR="$HOME/.config/se-tools"
TOKEN_FILE="$CONFIG_DIR/gh_token.txt"
MAX_AGE=80

mkdir -p "$CONFIG_DIR" && chmod 700 "$CONFIG_DIR"

check_token() {
    if [[ -f "$TOKEN_FILE" ]]; then
        created=$(head -n1 "$TOKEN_FILE")
        token=$(tail -n1 "$TOKEN_FILE")
        age=$(( ( $(date +%s) - created ) / 86400 ))
        if (( age < MAX_AGE )); then
            GITHUB_TOKEN="$token"
            return 0
        fi
    fi
    return 1
}

refresh_token() {
    read -s -p "üîë Neues GitHub-Token: " GITHUB_TOKEN
    echo
    echo -e "$(date +%s)\n$GITHUB_TOKEN" > "$TOKEN_FILE"
    chmod 600 "$TOKEN_FILE"
}

check_token || refresh_token

if [ -z "$1" ]; then
    echo -e "${RED}‚ùå Projektnamen angeben!${NC}"
    exit 1
fi

PROJECT_NAME=$1
ZIELORDNER="$PWD/$PROJECT_NAME"

if [ -d "$ZIELORDNER" ]; then
    echo -e "${RED}‚ùå Ordner '$ZIELORDNER' existiert bereits.${NC}"
    exit 1
fi

# Klonen
git clone "$TEMPLATE_REPO" "$ZIELORDNER"
cd "$ZIELORDNER"
rm -rf .git && git init
touch .gitignore && echo -e ".env\n.DS_Store\nnode_modules" > .gitignore
git add . && git commit -m "üÜï Neues Projekt: $PROJECT_NAME"

# GitHub Repo
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
    -H "Authorization: token $GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"name\":\"$PROJECT_NAME\", \"private\":false}" \
    "$GITHUB_API/user/repos")

if [ "$RESPONSE" != "201" ]; then
    echo -e "${RED}‚ùå Fehler bei GitHub Repo-Erstellung.${NC}"
    exit 1
fi

git remote add origin "https://github.com/$USERNAME/$PROJECT_NAME.git"
git branch -M main
git push -u origin main

echo -e "${GREEN}‚úÖ Projekt '$PROJECT_NAME' erstellt & auf GitHub gepusht.${NC}"
